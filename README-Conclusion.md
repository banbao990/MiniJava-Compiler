## 6. 总结与思考

[总目录](README.md)

----

[TOC]

### 6.1 课程收获

#### 6.1.1 概述

+ 首先作为最后一届独立的《编译实习》课程的学生，感觉挺荣幸的。
+ 整个的课程虽然只有 `2` 学分，但是整体上的收获到的肯定不止两学分

#### 6.1.2 知识收获

+ 整体而言，做完编译实习的 `5` 个实习之后，还是收获很大的
+ 最直接的收获当然是能够自己写出了一个 `minijava` 到  `mips` 的编译器了
    + 虽然说代码质量不太高，但是也算是写过编译器的人了

##### 理论知识理解

+ 对于《编译技术》理论课上的一些方法也有了更深的理解，例如在学习代码生成那一章节时，寄存器分配这个概念虽然有所了解，但是实际的操作并不是太了解，经过自己在 `spiglet2kanga` 那部分代码生成的实习，也感受到了寄存器分配具体实现的难点。

##### 设计模式

+ 说实话在接触《编译实习》这门课之前并没有接触过 `visit-accept` 设计模式。
+ `visit-accept` 这种设计模式的确很好，在代码更新上十分方便，只需要进行一小部分的修改即可

##### java 语言

+ 之前虽然也学过 `java` ，但是实际操作比较少，经过这个学期完成了这整个项目之后，感觉对于 `java` 一些内置库的运用更加熟练。同时在学习 `minijava` 的过程中也学到了很多更加底层的知识。

##### JAVACC，JTB

+ 也学习到了这两个工具的运用，这两个工具在使用上的确很方便。不仅仅是课程实习中，在以后的学习或者工作上，如果有这方面的需求的话，只需要自己编写或者修改 `.jj` 文件便能很方便生成词法、语法分析树，进而进行接下来的工作。
+ 关于这两个工具的使用，也从一开始的只会 `accept` 到后来的逐渐了解到可以使用具体的结点信息，对于这两个工具的使用也的确越来越熟练，在最后尝试了下尽量多使用结点信息，不过还是没太成功。

##### 编译器的理解

+ 在对编译器的理解上也有了更深的认识，明白了编译器是怎么将初始的代码转化为汇编级指令的。
    + 一开始的查错
    + 逐步转化类、数组等高级概念
    + 复合结构的转化
    + 有限寄存器的分配
    + 栈的操作
+ 自己写完这些代码之后，感觉也的确对于代码的编译有了更深的理解

##### 项目设计

+ 在整个项目的代码编写过程中，除了在 `TypeChecker` 中对于一些循环继承的等的处理，以及后面关于变量活性分析、寄存器分配之外，涉及的算法其实不是太多，就算涉及，基本上也给出了算法的实现原理，实现上也并非太复杂，最难的部分还是在怎么样去设计整体的框架。
+ 印象深刻的部分就是在 `minijava2piglet` 的部分，这里涉及到很多的代码转换，怎么样具体是实现，是在父结点输出还是在子结点输出，具体的考量对于训练我们的设计能力很有帮助。
+ 还有关于最后的 `spiglet2kanga` 中关于 `Label` 的输出，同样都是 `Label` ，最前面的 `Label` 就要输出， `JUMP` 语句后面跟的 `Label` 就需要通过处理后输出，这些的具体实现就挺启发人思考的，也很有趣。

##### 代码优化

+ 在进行寄存器的分配过程(`spiglet2kanga`)中对于代码优化有了一些自己的理解
+ 这些理解也是源于一个 `BUG`
    + 活性分析本质上就是一个代码优化的过程，不进行活性分析，可以简单的认为一个变量的活性区间是从一开始定义的地方，直到整个 `Procedure` 结束为止，这样也没错，只是生成的代码质量极低而已。
    + 在进行 ` "HLOAD Temp Temp IntegerLiteral` 语句翻译的时候应该将第一个 `TEMP` 放到集合 `id` 里面，也就是说认为这个变量在该语句不活跃，但是当时不知手抖还是为啥把他放到了集合 `vars` 里面（相当于认为其活跃），这个时候在生成 `BinaryTree.spg` 对应的 `.kg` 文件竟然从原来的 `2000` 行激增到 `3000` 行，这让我理解了代码优化的好处。
    + 上面这个 `BUG` 本质上就是扩大了变量原本的活性区间，导致寄存器分配时溢出更多的变量，最终导致更多的 `ALOAD/ASTORE` 操作，使得代码冗长而且性能下降。
+ 而且在 `spiglet2kanga` 的总结部分也分析到代码优化的难点，这也使得我对能够写 `C++` 底层代码优化的大佬们充满敬佩之情。

##### 调试技能

+ 经过这个项目的训练，`eclipse` 调试技能点真的打满

##### cmd

+ 一个额外收获是在调试过程中为了方便，学习了一下  `cmd` 的批处理操作
+ 感觉还是挺有用的

##### 读汇编代码技能

+ 在具体代码生成的过程中大量参考了示例代码中的 `BubbleSort` 的代码转换，很多时候设计遇到问题的时候多亏了有这个示例，才能够很好的实现我的代码转换，尤其是以下两个部分
    +  `minijava2piglet`（转换太多）
    +  `kanga2mips`  中学习具体的语句的转化（`mips` 语言 `BNF` 过于复杂）
    + 谢谢 `ucla` 爸爸

+ 然后在这个过程中，感觉也训练了自己读汇编代码的能力（感觉比 `ics` 效果还好）

#### 6.1.3 其他收获

+ 说实话在整个课程中知识上的收获还是一个方面，感觉自己在这个项目中也成长了不少，下面记录一下我的整个心路历程
+ 一开始接触的时候完全不熟悉 `AST` 的使用，然后就只能对着老师给的代码进行模仿，到最后很多地方可能和老师一开始的想法不太一样，导致后多地方陷入了瓶颈，可以看到 `Typechecker` 的代码写的略显杂乱，而且当时看到自己的代码能跑了之后，天哪，那种喜悦之情，感觉就很快乐，第一次看到自己的写出项目之后的快感。
+ 然后到第二个任务 `minijava2piglet`，说实话我觉得这一部分的代码生成是最麻烦的，需要考虑很多因素。挺后悔的是当时不知道为啥把这个实习作业拖到了最后面三四天才开始做，导致最后上交的版本连 `8` 个样例都过不了。直到第二天才调试出来具体的问题，最后发现是多态的符号表的问题，当时把他简单化处理了。然后从那次之后，感觉也渐渐开始丢掉拖延的习惯。
+ 到了 `piglet2spiglet`，这个时候已经能够比较熟练的运用 `AST`，不过也由于这一部分比较简单，没有进行什么比较复杂的处理。
+ 到 `spiglet2kanga`，已经开始能够自己有些想法，例如对于 `Stmt` 语句中的各个变量在具体的 `Constraint` 里须要扮演什么角色(`id,vars`)，已经能够简单的脱离老师的课件开始设计具体的每个结点的实现，而且也开始有了优化自己的代码（指写的 `java` 代码）的想法。
+ `kanga2mips` 感觉这一个部分基本上就没有看老师的 `PPT`，可以自己比较流畅的设计下来整体实现，而且对于 `java` 代码在编译过程中的性能也有了自己的想法，大量采用结点信息而不是开销更大的函数调用，感觉自己还是有所成长。
+ 总而言之，能够清晰地感受到自己在整个过程中的成长，是门很棒的课，在《编译技术》理论的实习方面，在`JAVACC,JTB` 的工具使用方面，在对我们的思维训练方面。



### 6.2 课程建议

+ 有一点小建议就是可能把 `spiglet2kanga`，`kanga2mips` 这两个部分划为一个部分感觉会更好一点。
    + 因为在 `spiglet2kanga` 的部分，每个人对于寄存器的使用可能有自己的一套方式，简单地说，对于 `a` 系寄存器是否需要重新分配寄存器，我是没有重新分配的，这样子在 `kanga2mips` 的部分，如果我们自己写 `_print` 函数的时候，需要额外在栈上开辟 `4` 个字节用于在调用 `_print` 函数时的 `a0` 寄存器的保存。同样对于 `v0` 的使用也是，如果 `v0` 用于分配寄存器的话，此时同样也要多开空间保存 `v0`
        + 不过现在想想如果把 `a` 系寄存器重新分配的话，如果在大量调用函数的时候的确也会起到代码优化的效果。这也是个权衡吧。
        + 当然上述问题也是可以解决的，就是不包装 `_print` ，每一次就单纯的进行系统调用就行了，这样就不涉及 `a` 系寄存器，当然 `v0` 还是一样
    + 由于我们不知道具体的实现，即不知道输入的 `kg` 代码使用习惯，每次都需要采用多开 `8` 个字节保存 `a0,v0` ，这也使得代码性能有所下降
    + 但是如果是自己的生成的 `kg` 代码，这样对于寄存器的使用很熟悉，例如如果堆 `a` 系寄存器重新分配寄存器的话，这样就不需要在进行系统调用的时候保存 `a0`，对于代码优化也是一个帮助。而且这也更加符合这整个项目的要求。
+ 其实我想说的就是用我们自己写的 `spiglet2kanga` 生成的 `kg` 代码作为 `kanga2mips` 的输入，这样可能生成代码冗余指令会少些。
    + 当然由于我们生成的 `kg` 代码质量不高，实际运行起来可能并不会快。
+ 好像 `ucla` 上面有新的项目，或许可以试试？
    +  http://web.cs.ucla.edu/~palsberg/course/cs132/newproject/
        + 但是具体内容好像 `404`
    +   http://web.cs.ucla.edu/classes/spring11/cs132/kannan/index.html
        + 这个可以



## 7. 致谢

+ 感谢老师和助教一学期的陪伴，从自己调试代码的过程来看，感觉助教的工作量还是蛮大的，尤其是在最后一部分 `mips` 代码的调试上，感觉还是挺辛苦的。
+ 学习遇到困难的时候，在群里也能及时地得到老师的解答，十分感谢。
+ 也感谢这一学期一起学习的同学们，大家一起度过了这个不一样的学期。
+ 最后祝愿所有人都能够顺利完成课业，能够体会到学习知识的快乐。